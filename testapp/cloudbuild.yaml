steps:
# 1. Build the Docker image
- name: 'gcr.io/cloud-builders/docker'
  dir: /workspace  # <-- ADDED: Force the step to run from the repo root
  args:
    [
      'build',
      '-t',
      'gcr.io/$PROJECT_ID/underwater-app:latest',
      '-f', 'testapp/Dockerfile',  # <-- ADDED: Explicitly point to the Dockerfile
      'testapp'  # <-- CHANGED: Tell Docker the build context is the 'testapp' folder
    ]

# 2. Push the image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/underwater-app:latest']

# 3. Deploy the image to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
    [
      'run',
      'deploy',
      'underwater-enhancer-service',
      '--image=gcr.io/$PROJECT_ID/underwater-app:latest',
      '--region=us-central1',
      '--platform=managed',
      '--allow-unauthenticated',
      '--memory=2Gi',
      '--cpu=1',
      '--cpu-boost',
      '--timeout=300'
    ]

images:
- 'gcr.io/$PROJECT_ID/underwater-app:latest'

options:
  logging: CLOUD_LOGGING_ONLY
timeout: '1800s'
